# 关于 DUML 的研究

RoboMaster EP 通过 DUML 协议与电脑通讯

DUML, 即 DJI Universal Markup Language (DJI 通用标记语言)，是 DJI 用于飞控与地面站通讯的协议

## 参考资料

- DUML 在中文互联网上少的可怜的提及：
  - [大疆无人机被曝16个安全漏洞：可破解禁飞限制、飞行中强制坠落 - 安全内参](https://www.secrss.com/articles/52508)
  - [[翻译]大疆无人机安全与DroneID漏洞](https://bbs.kanxue.com/thread-276355.htm)
  - 一些研究论文
    - [Drone Security and the Mysterious Case of DJI’s DroneID](https://www.ndss-symposium.org/wp-content/uploads/2023/02/ndss2023_f217_paper.pdf)
      Page 3 有 DUML 相关描述 
      以及 `Fig. 14. Calculation of the different fields of a DUML command` 和 `Fig. 15. Parsing of the different fields of a DUML command`
    - [Penetration testing a civilian drone Reverse engineering software in search for security vulnerabilities](https://kth.diva-portal.org/smash/get/diva2:1463784/FULLTEXT01.pdf)
      Page 22 有 DUML 相关描述
- [github.com/o-gs/dji-firmware-tools](https://github.com/o-gs/dji-firmware-tools)
- [Wireshark 分析套件](https://github.com/o-gs/dji-firmware-tools/tree/master/comm_dissector)
- [DJI Wiki](https://wiki.dji-rev.com/)
- [EP 实现](/Sdk/src/robomaster/duss_event_msg.py)
  [常量](/Sdk/src/robomaster/duml_cmdset.py)
  [Pack 解包实现](/Sdk/src/robomaster/duss_event_msg.py#L104-L124)

## 结构体

注: `///` 和 `##` 为编者所加

```c
struct duml_packet {
    /// Header
    uint8_t identifier;
    // LSB of length
    uint8_t len;
    /*
    * MSB of length and DUML version
    * ((version << 2) | (length >> 8) & 0x3
    */
    uint8_t version_msb;
    uint8_t crc8;

    /// Body
    uint8_t src;
    uint8_t target;
    /*
    * sequence number, increments
    * per packet sent
    */
    uint16_t seq_num;
    uint8_t cmd_type;
    uint8_t cmd_set;
    uint8_t cmd_id;
    uint8_t data[N];
    uint16_t crc16;
    /* ... */
};
```

```python
def pack(self):
    ## pack header
    self.data_buff = []
    self.get_data()
    self.length = len(self.data_buff)
    pack_size = self.length + DUSS_MB_PACKAGE_V1_HEAD_SIZE + DUSS_MB_PACKAGE_V1_CRC_SIZE
    verlen = [pack_size & 0xff] + [(1 << 10 | pack_size) >> 8]
    crc_h_data = [0x55] + verlen
    crc_h_t = duml_crc.duss_util_crc8_append(crc_h_data, DUSS_MB_PACKAGE_V1_CRCH_INIT)       #return a list

    ## pack body
    crc_data = [0x55] + verlen + crc_h_t + hostid2packid(self.sender) + hostid2packid(self.receiver) + _seqid2packid(self.seq_num) + \
                [self.cmd_type] + [self.cmd_set] + [self.cmd_id] + self.data_buff
    crc_t = duml_crc.duss_util_crc16_append(crc_data, DUSS_MB_PACKAGE_V1_CRC_INIT)

    package_combine = crc_data + crc_t

    if self.debug:
        logger.info(list(map(lambda x: hex(x), package_combine)))

    package_byte = tools.pack_to_byte(package_combine)

    return package_byte
```

### 字段说明

#### Header
- `identifier` 为固定值 `0x55`, 作为起始标志
- `len`/`verlen` 为数据长度和版本
- `crc8`/`crc_h_t` 为 Header 校验和

#### Body
- `src`/`sender` 为源 ID
  在 EP 中，`sender` 取自 `EventClient.my_host_id`, 其默认值为 `rm_define.script_host_id`  
  除 [dji_scratch.py](/Sdk/bin/dji_scratch.py) 为 `rm_define.system_host_id` 外，其余均为 `rm_define.script_host_id`  
  [rm_define.py](/Sdk/src/robomaster/rm_define.py#L2-L4) 中定义了 `system_host_id` 和 `script_host_id`
  ```python
  # event client
  system_host_id = 0x905
  script_host_id = 0x906
  ```
- `target`/`receiver` 为目标 ID
  在 EP 中，`receiver` 取自 `rm_define.xxx_id`, 具体取值见 [rm_define.py](/Sdk/src/robomaster/rm_define.py#L712-L758)
- `seq_num` 为 seq 序列号
- `cmd_type` 为命令类型
- `cmd_set` 为命令集
- `cmd_id` 为命令 ID
- `data`/`data_buff` 为数据
- `crc16`/`crc_t` 为所有数据校验和, 包括 Header 和 Body
  